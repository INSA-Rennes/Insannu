<?php

require('../secret/mysql_register.php');

if(isset($_GET['id'])) {
	try {
		$query = $GLOBALS['bdd_mysql']->prepare("SELECT * FROM students WHERE id = ?");
		$query->execute(array($_GET['id']));
	} catch(Exception $e) {
		exit('Error: '.$e->getMessage());
	}
	if($result = $query->fetch()) {
		try {
			$query = $GLOBALS['bdd_mysql']->prepare("SELECT * FROM load_logo WHERE id = ? AND ip_address = ?");
			$query->execute(array($_GET['id'], $_SERVER['REMOTE_ADDR']));
		} catch(Exception $e) {
			exit('Error: '.$e->getMessage());
		}
		if(!($result = $query->fetch())) {
			try {
				$query = $GLOBALS['bdd_mysql']->prepare("INSERT INTO load_logo(date, id, ip_address, user_agent) VALUES(?, ?, ?, ?)");
				$query->execute(array(time(), $_GET['id'], $_SERVER['REMOTE_ADDR'], $_SERVER['HTTP_USER_AGENT']));
			} catch(Exception $e) {
				exit('Error: '.$e->getMessage());
			}
		}
	}
}

header("Pragma: public");
header("Expires: 0");
header("Cache-Control: must-revalidate, post-check=0, pre-check=0");
header("Content-type: image/gif");
header("Content-Length: ".filesize('tmp/logo.gif'));
readfile('tmp/logo.gif');

?>